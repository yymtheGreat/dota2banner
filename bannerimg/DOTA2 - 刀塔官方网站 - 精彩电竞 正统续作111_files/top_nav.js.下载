(function() {
    var navTemp = [
        '<div id="dota2_topnav" class="dota2_nav_container">',
        '<div class="nav_main clearfix">',
        '       <a href="//www.dota2.com.cn/" title="《DOTA2》官方网站" class="nav_logo" target="_blank">《DOTA2》官方网站</a>',
        '       <div class="dota2nav" id="dota2nav">',
        '           <div class="link_div">',
        '               <a href="//www.dota2.com.cn/main.htm" target="_blank" id=" link_nav1" class="link_nav">',
        '                   <span>首页</span>',
        '                   <span class="link_nav_e">HOME</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//www.dota2.com.cn/" target="_blank">品牌站</a>',
        '                   <a href="//members.dota2.com.cn/login?url=/info" target="_blank">个人中心</a>',
        '                   <a href="http://secretshop.dota2.com.cn/" target="_blank">神秘商店</a>',
        '                   <a href="http://fx.wanmei.com/dota2/" target="_blank">玩家工坊</a>',
        '               </div>',
        '           </div>',
        '           <div class="link_div">',
        '               <a href="//www.dota2.com.cn/news/index.htm" id="link_nav2" class="link_nav" target="_blank">',
        '                   <span>资讯</span>',
        '                   <span class="link_nav_e">NEWS</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//www.dota2.com.cn/news/gamenews/index.htm" target="_blank">官方新闻</a>',
        '                   <a href="//www.dota2.com.cn/news/competition/index.htm" target="_blank">赛事新闻</a>',
        '                   <a href="//www.dota2.com.cn/news/gamepost/index.htm" target="_blank">更新日志</a>',
        '                   <a href="//www.dota2.com.cn/raiders/index.htm" target="_blank">游戏攻略</a>',
        '               </div>',
        '           </div>',
        '           <div class="link_div">',
        '               <a href="//www.dota2.com.cn/activity/gamematch/index.htm" id="link_nav3" class="link_nav" target="_blank">',
        '                   <span>赛事</span>',
        '                   <span style="margin-left: -7px;" class="link_nav_e">TOURNAMENTS</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//www.dota2.com.cn/procircuit/" target="_blank">职业赛季</a>',
        '                   <a href="//act.dota2.com.cn/match" target="_blank">赛事中心</a>',
        '                   <a href="//act.dota2.com.cn/match/list" target="_blank">赛事总览</a>',
        '                   <a href="//www.dota2.com.cn/activity/gamematch/index.htm" target="_blank">赛事专题</a>',
        '               </div>',
        '           </div>',
        '           <div class="link_div">',
        '               <a href="//www.dota2.com.cn/zlz/index.htm" id="link_nav4" class="link_nav" target="_blank">',
        '                   <span>互动</span>',
        '                   <span class="link_nav_e">INTERACTION</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//www.dota2.com.cn/activity/all/index.htm" target="_blank">精彩综合</a>',
        '                   <a href="//www.dota2.com.cn/activity/gameevent/index.htm" target="_blank">官方活动</a>',
        '                   <a href="http://bbs.dota2.com.cn/forum.php" target="_blank">玩家论坛</a>',
        '                   <a href="//weibo.com/dota2comcn" target="_blank">新浪微博</a>',
        '                   <a href="javascript:;" id="j-navwxlink">官方微信</a>',
        '               </div>',
        '           </div>',
        '           <div class="link_div">',
        '               <a href="//www.dota2.com.cn/zlz/index.htm" id="link_nav4" class="link_nav" target="_blank">',
        '                   <span>资料</span>',
        '                   <span class="link_nav_e">DATA</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//www.dota2.com.cn/heroes/index.htm" target="_blank">英雄资料</a>',
        '                   <a href="//www.dota2.com.cn/items/index.htm" target="_blank">物品资料</a>',
        '                   <a href="//maps.dota2.com.cn/" target="_blank">自定义地图</a>',
        '                   <a href="//www.dota2.com.cn/guide" target="_blank">新手引导</a>',
        '               </div>',
        '           </div>',
        '           <div class="link_div">',
        '               <a href="http://bbs.wanmei.com/forum.php?mod=forumdisplay&fid=192" target="_blank" id="link_nav5" class="link_nav">',
        '                   <span>服务</span>',
        '                   <span class="link_nav_e">SERVICE</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//kf.dota2.com.cn" target="_blank">客服中心</a>',
        '                   <a href="http://cs.wanmei.com/genius?imCode=imdotagames" target="_blank">在线客服</a>',
        '                   <a href="http://cs.wanmei.com/getServicesByGameType?gametype=22" target="_blank">自助专区</a>',
        '                   <a href="//kf.dota2.com.cn/home/ques?id=183&cid=101&lpid=" target="_blank">被盗找回</a>',
        '                   <a href="//kf.dota2.com.cn/home/ques?id=83&cid=271&lpid=251" target="_blank">忘记账号</a>',
        '                   <a href="//members.dota2.com.cn/findPwAccount" target="_blank">通行证查询</a>',
		'                   <a href="//wb.dota2.com.cn/" target="_blank">网吧特权</a>',
		'                   <a href="http://www.wanmei.com/jiazhang/index.htm" target="_blank">家长监护</a>',
        '               </div>',
        '           </div>',
        '           <div class="link_div">',
        '               <a href="//www.dota2.com.cn/download/" target="_blank" id="link_nav6" class="link_nav">',
        '                   <span>下载</span>',
        '                   <span class="link_nav_e">DOWNLOAD</span>',
        '               </a>',
        '               <div class="link_pop">',
        '                   <a href="//www.dota2.com.cn/download/" target="_blank">游戏下载</a>',
//      '                   <a href="http://app.dota2.com.cn/web.html" target="_blank">刀塔助手</a>',
        '                   <a href="//www.dota2.com.cn/enjoy/gamewall/index.htm" target="_blank">精美壁纸</a>',
        '                   <a href="//www.dota2.com.cn/comics/index.htm" target="_blank">官方漫画</a>',
        '               </div>',
        '           </div>',
        '       </div>',
        '       <div class="dota2user hide" id="dota2user">',
        '           <div class="info">',
        '               <i class="nav-avatar avatar-default"></i>',
        '               <div class="enter-box"><p class="name"><span>您好，请&nbsp;</span><a href="javascript:;" id="J_dota2SignIn">登录</a></p>',
        '               <span class="tt">登录后可进入您的个人中心</span></div>',
        '           </div>',
        '       </div>',
        '   </div>',
        '   <div id="Dota2_overlay"></div>',
        '   <div class="Dota2dialogWrap" id="J_dialog_dota2_passport" style="background:#070707 ">',
        '       <a href="javascript:;" class="close-passport"></a>',
        '       <iframe width="" height="" frameborder="0" scrolling="no" data-src="//passport.wanmei.com/sso/accounts/serviceLogin?continue=//www.dota2.com.cn/sso/loginPc&service=dota2_act&isiframe=1&location=//www.dota2.com.cn/main.html"',
        '           src="https://img.dota2.com.cn/file/6b/66/6b66dabeefc529cf357ea993b87d6f741543556849.png" name="passport_login_iframe_parent" allowtransparency="true"></iframe>',
        '   </div>',
        '   <div class="nav_wxdialog" id="j-navwxdialog" style="display: none;">',
        '            <h4>扫一扫关注DOTA2官方微信公众平台</h4>',
        '        <p>获取更多最新的DOTA2精彩资讯！</p>',
        '        <ul>',
        '            <li class="subscribe">',
        '                <i></i>',
        '                <span>DOTA2官方微信服务号</span>',
        '            </li>',
        '            <li class="vservice">',
        '               <i></i>',
        '               <span>DOTA2官方微信订阅号</span>',
        '            </li>',
        '       </ul>',
        '       <a href="javascript:;" class="close" id="j-wxclose"></a>',
        '</div>',
        '</div>'
    ].join("");

    var xhr_checkoutStatus = null;
    var baseHref = '//www.dota2.com.cn';

    $(function() {
        var link_header = $('<link rel="stylesheet">');
        var link_login = $('<link rel="stylesheet">');
        var script_login = $('<script async defer></script>');
        var script_header = $('<script async defer></script>');

        var header = $('head').eq(0);
        var body = $('body');
        var now = '20181212';

        link_header.attr('href', baseHref + '/style/header.css?v=' + now);
        link_login.attr('href', baseHref + '/style/libs/jquery.dota2.login.css?v=' + now);
        script_login.attr('src', baseHref + '/js/libs/jquery.dota2.login.js?v=' + now);
        script_header.attr('src', baseHref + '/js/header.js?v=' + now);

        header.append(link_header);
        header.append(link_login);

        link_header.load(function() {
            body.prepend(navTemp);
            body.append(script_login);
            body.append(script_header);
            checkoutStatus();
        });
    });

    function checkoutStatus() {
        if (xhr_checkoutStatus) xhr_checkoutStatus.abort();
        var url = encodeURIComponent(window.location.href);
        xhr_checkoutStatus = $.ajax({
            type: 'GET',
            async: true,
            url: baseHref + '/user/info?lr=' + url,
            dataType: 'jsonp',
            jsonp: 'callback',
            jsonpCallback: 'callbackStatus'
        })
            .done(function(data){
                if (data.status == "success") {
                    fillStatus(data['data']);
                }
            })
            .always(function() {
                $('#dota2user').removeClass('hide');
            });
    }

    function logedSteamTemp(){
        return  '<div class="info-st userin">' +
            '<i class="nav-avatar avatar-default"></i>' +
            '<div class="enter-box"><p class="name"><span class="name-info">您暂未绑定DOTA2账号信息</span><a href="//www.dota2.com.cn/guide" target="_blank">进行游戏</a> <span>&nbsp;后即可绑定</span></p></div>' +
            '</div>';
    }

    function logedTemp(avatar,username){
        return  '<div class="info userin">' +
            '<img class="nav-avatar" src="' + avatar + '" alt="' + username + '">' +
            '<a class="enter-box" href="http://members.dota2.com.cn/info"><p class="name"><span>您好，</span><b  title="' + username + '">' + username + '</b></p>' +
            '<span class="tt">点击进入您的个人中心</span></a>' +
            '</div>';
    }

    function fillStatus(data) {
        var navMain = $('#dota2_topnav');
        var userContainer = $('#dota2user');
        var iframe = $('#J_dialog_dota2_passport iframe');
        var userHtml,
            is_bind_steam = data['is_bind_steam'];
        iframe.attr('data-src', data['login_url_iframe']);

        if (data['login_status'] == true || data['login_status'] == 'true') {
            navMain.addClass('nav_main_loged');
            userHtml = is_bind_steam
                ? logedTemp(data['avatarfull'], data['personaname'])
                : logedSteamTemp();
            userContainer.html(userHtml);

        } else if (data['is_mobile']) {
            $('#J_dota2SignIn').attr({
                'data-href': data['login_url_mobile'],
                'data-mobile': true
            });
        }
    }
})();

